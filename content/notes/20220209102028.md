+++
title = "📝Clojure API Client Development"
tags = ["WIKI", "Clojure", "API"]
draft = false
+++

-   up: [📝Clojure Web Development]({{< relref "20220118092453.md" >}})
-   refs:
    -   [📝Clojure with Twitter Development]({{< relref "20220307193727.md" >}})

主にサービスのAPIを叩くクライアントプログラムのノウハウまとめ.


## Clojure HTTP Client {#2c684c}

主なクライアントライブラリにhttp-kitとclj-httpがある.

-   <https://github.com/http-kit/http-kit>
-   <https://github.com/dakrone/clj-http>

httpリクエストに関してはどちらも同じことができる. 非同期発行も.

ただしポイントはwebsocketが統合されているかどうか.

http-kitは2022年現在メンテナンス状況が怪しく見えた.


## clj-http {#13a79f1f-0d95-4f2a-8c4c-b77c4ed69be1}

<https://github.com/dakrone/clj-http>

[Ring]({{< relref "20220118092453.md#564c8e99-d6d7-49cf-acf8-6382d36443cb" >}}) の影響を受けているため Request Mapを入力としてResponse Mapを返す.


### tips: debug 出力 {#f8e61e}

{:debug true} をRequest Mapに含めると, 標準出力にRequest Mapの内容が表示される.


### tips: clj-httpにおけるjsonの扱い {#b919f5}

ClojureでJSONを扱うライブラリである [darkrone/cheshire](https://github.com/dakrone/cheshire) をインストールすると, jsonとの連携が{:as :json} でできる. この指定がされると clj-httpはrepsonse dataをcheshire でjsonにパースする.

なお 単純に {:headers {:accept "application/json"}}を設定したいだけなら{:accept :json}を指定する.

ref: [💡Accept と Content-Typeの違い]({{< relref "20220324072101.md#66adf489-f4af-4c2c-8357-4644e205372f" >}})


### howto: HTTPエラーの扱いと例外ハンドリング {#5ec1072e-8666-402b-a867-b6fd3d227eee}

HTTP Responseが正常終了以外の場合は[slingshot]({{< relref "20220331055419.md#2e6ef68b-b405-489c-8194-17a5e54f3b6d" >}})のインスタンスを返すため, slingshotに合わせたエラーハンドリングが期待される.

-   [Exceptions - GitHub - dakrone/clj-http](https://github.com/dakrone/clj-http#exceptions)
    -   clj-http READMEの説明.
-   [Simple error handling using slingshot and clj-http - Oskar Thorén](https://blog.oskarth.com/simple-error-handling-using-slingshot-and-clj-http)
    -   シンプルなerror handling wrapper実装例.
-   [Handling Exceptions with Middleware in Clojure | 8th Light](https://8thlight.com/blog/mike-knepper/2015/05/19/handling-exceptions-with-middleware-in-clojure.html)
    -   wrap-exceptionというカスタムwrapperと [ring-json]({{< relref "20220118092453.md#b55a2c8e-8f19-4719-9014-8bf43fedb0a8" >}}) の組み合わせ.


### howto: clj-httpのリクエストをproxy経由にするには？ {#e7d185}

Request Mapに proxy-host, prox-port, proxy-user, proxy-passを含める.

ref: [clj-http: Proxies](https://github.com/dakrone/clj-http#proxies)


### howto: clj-httpで WARN log: Invalid 'expires' attribute {#2facd0}

request mapのオプションに **:cookie-policy :standard** を追加.

ref: [Invalid 'expires' attribute? - GitHub](https://github.com/dakrone/clj-http/issues/325)


### howto: タイムアウト値を設定するには？ {#dc2d53}

Request Mapに 値をmillsecondで設定.

```clojure
{:socket-timeout 1000
:connection-timeout 1000
:connection-request-timeout 1000}
```

clj-httpは JavaのApache HttpClentのWrapperであり仕様はこれに従う. 設定可能な３つの属性の意味はそれぞれ以下の通り.

-   socket timeout: ソケット通信のスタートから終了まで.
-   connection timeout: クライアントからサーバへの接続確立(3way-shake)まで
-   connection-request-timeout: 接続確立後からレスポンスが返るまで.

ref. [JavaのHttpClientにおける3つのTimeoutの違いに関して - Qiita](https://qiita.com/Kohei-Sato-1221/items/5567b24c9d9218424c08)


### ページが存在するかチェックするには? {#921c89}

スクレイピング用途で利用するときに404がかかるとわかっているならばgetを投げないほうがいい. こんなときはhead requestで事前に存在確認したい.

ただしclj-httpではエラーコードは自動で例外を上げるため, それを防止して自分で中身のコードをチェックするときはRequest Mapに {:throw-exceptions false} を設定する.

```clojure
(defn page-exists? [url]
  (if-let [resp (client/head url {:headers          headers
                                  :throw-exceptions false})]
    (= (:status resp) 200)
    false))
```


## Clojure API Client開発のトピック {#52871d}


### Clojureでクエリ文字列を生成するには? {#73a87b}

[クエリ文字列]({{< relref "20220324072101.md#28c64a45-7f21-461e-b53a-18d5875ae734" >}})をClojureで生成する方法

-   ring.util.codec/url-encode を使う.
-   clj-http.client/generate-query-stringを使う.
-   java.net.URLEncoder/encodeを使う.

---

ref. [Clojure building of URL from constituent parts - Stack Overflow](https://stackoverflow.com/questions/3644125/clojure-building-of-url-from-constituent-parts)


## References {#d95867}

勉強の参考に目を通したもののブックマーク.

-   [ClojureでQiita APIをたたく - Qiita](https://qiita.com/akthrms/items/42af315089229800aefa)
    -   <https://github.com/akthrms/qiita-client-sample>
    -   Qiitaを叩くだけだけど余計なものがないのでよい.
-   [Clojure tutorial - boot, basic functions and how to do REST requests](https://joaoptrindade.com/clojure-tutorial-part-1-http-requests)
    -   とくにClojureのREST requestsに着目したチュートリアルWeb記事.
    -   example of clj-http
    -   <https://github.com/joninvski/clojure-tutorial>
