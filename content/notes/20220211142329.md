+++
title = "📝Clojure Product Development"
tags = ["WIKI"]
draft = false
+++

up: [📂Clojure Development]({{< relref "20220211141917.md" >}}) tags: [🏷Clojure]({{< relref "20211111225741.md" >}})

Clojure開発であれどうやるんだっけというライブラリをまとめる.

-   refs:
    -   [📝Clojure Web Development]({{< relref "20220118092453.md" >}}) : Web関係はこっち
    -   [📝Clojure API Client Development]({{< relref "20220209102028.md" >}}) : Client API関係はこっち:


## Clojure命名規約 {#clojure命名規約}

[Clojureスタイルガイド](https://totakke.github.io/clojure-style-guide/) が大変参考になる. あとはGitHubで他人-のコードリーディング.

ここにはとりあえず身につけたい努力目標をメモしていく. 本当はスタイルとかは個人の努力に頼るのはアンチパターンでツールでチェックするのがいいんだけどな...そういうツールはおいおい調査.


### 関数名や変数名は kebab-case aka. lisp-case {#関数名や変数名は-kebab-case-aka-dot-lisp-case}

ref: <https://totakke.github.io/clojure-style-guide/#lisp-case>

[🏷kebab-case]({{< relref "20220308155618.md#変数の命名規約" >}})

別の命名規約との変換のライブラリとして,
Clojureでは camel-snake-kebab というものが有名.

<https://github.com/clj-commons/camel-snake-kebab>

マイクロサービス開発だと, 各言語によって変数名が異なるので変換が必要.

[Clojureで作ったAPIをマイクロサービスの海に隠す - ayato-p](https://scrapbox.io/ayato-p/Clojure%E3%81%A7%E4%BD%9C%E3%81%A3%E3%81%9FAPI%E3%82%92%E3%83%9E%E3%82%A4%E3%82%AF%E3%83%AD%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AE%E6%B5%B7%E3%81%AB%E9%9A%A0%E3%81%99)


### Protocols/Records/Structs/TypesはPascalCase {#protocols-records-structs-typesはpascalcase}

ref: <https://totakke.github.io/clojure-style-guide/#CamelCase-for-protocols-records-structs-and-types>

[🏷PascalCase]({{< relref "20220308155618.md#変数の命名規約" >}})


### private functionsには defn- で印をつける {#private-functionsには-defn-で印をつける}

ref: <https://totakke.github.io/clojure-style-guide/#private>


### 副作用の持つ関数は!, 変換をする関数の名称はtoではなく-&gt; {#副作用の持つ関数は-変換をする関数の名称はtoではなく}

e.g.) reset!


### Java Classでパフォーマンスが下がったら^でType Hintsをつける {#java-classでパフォーマンスが下がったら-でtype-hintsをつける}

reflection抑止によるコンパイル速度向上.

ref: <https://clojure.org/reference/java_interop#typehints>

どちらかというと，使うなという意味だな🤔

&gt;  Normally, one should avoid the use of type hints until there is a known performance bottleneck.

リフレクションってなに？と思ったら過去記事を書いてた...

[🖊Java のリフレクションでインスタンスやメソッドを動的生成する | Futurismo](https://futurismo.biz/archives/2715/)


### 定数に特別な表記をしない {#定数に特別な表記をしない}

JavaとかPythonで定数を大文字にする慣習は注意. Clojureでは全てが定数なので不要.

(def MAX-SIZE 10) ; Java style NG!!!


## Clojure: 状態管理 {#clojure-状態管理}

いろいろあるがナウいのはIntegrantかな？

-   [stuartsierra/component](https://github.com/stuartsierra/component)
-   [tolitius/mount](https://github.com/tolitius/mount)
-   [weavejester/integrant](https://github.com/weavejester/integrant/projects?type=beta)

状態管理ライブラリとは関数型パラダイム固有のものかな？ Redux的な.後で調べたい.


### Clojure: Integrant {#clojure-integrant}

[weavejester/integrant](https://github.com/weavejester/integrant)

-   integrant
    -   **configuration map** をもとに生成されるmicro-serviceの1つの単位.
-   configuration map
    -   keyの定義をまずする. これは具体的な実装へと初期化される入力情報.
    -   Clojureのmapとして表現するかEDNファイルとして外部ファイルに定義する.
    -   configuration map同士は **ig/ref** で 参照することができる.
-   ig/init-key で integrant serviceの初期化におけるデータと関数を定義.
-   ig/halt-key!でintegrant serviceのinit-keyの定義を破棄する関数を定義.
-   ig/initにconfiguration mapを渡すことで, 依存関係に従って integrant を初期化.
-   init/halt!で 破棄.

<!--listend-->

```clojure
(defmethod ig/init-key :handler/greet [_ {:keys [name]}]
  (fn [_] (resp/response (str "Hello " name))))
```

-   {:keys [name]}はClojure 分配束縛の記法.
    -   ref: [📝Destructuring]({{< relref "20220116094551.md#clojure-分配束縛--destructuring" >}})
-   keyに ::hogeみたいな 2つのコロンをみかける. ::hogeは :(namespace)/hogeの意味.
    -   REPLで評価するとわかる, reader syntax.

references:

-   [Integrant入門(1) - Integrantの基本 - ayato-p](https://scrapbox.io/ayato-p/Integrant%E5%85%A5%E9%96%80(1)_-_Integrant%E3%81%AE%E5%9F%BA%E6%9C%AC)
-   [はじめてのDuct - Uzabase Tech](https://tech.uzabase.com/entry/2018/04/03/115236)
    -   integrantについても書かれてる.


#### memo: Javaからのアナロジー {#memo-javaからのアナロジー}

クラスというものを単なる抽象データ構造と捉えると,
クラスには属性としての値と関数値の集合であり,
オブジェクトとはそれをメモリ上に領域確保した状態.

ig/init-keyでやっていることは値とその初期化関数のpairのbindingであり,
ig/init-keyで定義したpairの集合をig/initでまとめて初期化している.

そうすると, ig/init-keyで初期化したそれぞれのオブジェクトを１つのオブジェクトに
bindingして管理しているようにもみえる.
管理ということで, suspend, resume,
haltはオブジェクトをGoF Command patternで扱うようなものとして捉えれば納得がいく.

(アナロジーとして類推しただけで実装を読んではない...後で読む).


### Clojure: Duct {#clojure-duct}

<https://github.com/duct-framework/duct>

Integrantをベースにした拡張機能を提供.
Webフレームワークではなくもっと汎用的なもの, フレームワークのフレームワーク.

-   [Ductモジュール入門](https://www.slideshare.net/KentOhashi/duct-module-getting-started)


#### memo: Javaからのアナロジー {#memo-javaからのアナロジー}

小さな構成のシステムをJavaで作成するならモジュールごとにクラス分割するが,
Ductはクラスに初期化データとその方法を定義するためのコンストラクタを定義するようなものか?
責務を意識したクラス設計とはドメイン分割.


## Clojure: ロギング(Logging) {#clojure-ロギング--logging}

Javaの資産を使うか否かが採用のポイントかな？
Javaのロギングライブラリは歴史がある.
ログはViewerがよいとワクワクするからな.


### tools.logging {#tools-dot-logging}

<https://github.com/clojure/tools.logging>

clojure tools.logging libaryでJavaの資産を活用.

ref: [🖊Logbackのログを見やすくする方法(ファイルをgrep, Lilith) | Futurismo](https://futurismo.biz/archives/6825/)


### timbre {#timbre}

Pure Clojure/Script logging library.

<https://github.com/ptaoussanis/timbre>

[slf4j-timbre](https://github.com/fzakaria/slf4j-timbre) をつかうとJavaのロギングライブラリと連携可能.

なんかドキュメントがわかりにくいな...

日本の時刻設定例:

```clojure
(def timbre-config {:timestamp-opts {:pattern  "yyyy-MM-dd HH:mm:ss,SSS"
                                     :locale   (java.util.Locale. "ja_JP")
                                     :tiemzone (java.util.TimeZone/getTimeZone "Asia/Tokyo")}})
(timbre/merge-config! timbre-config)
```


## Clojure Architecture {#clojure-architecture}

Clojureのアプリケーション設計.

ref: [📝Clean Architecture]({{< relref "20220228062229.md" >}})

大きなテーマなので書くことが大きくなったら分割しよう.

-   [プログラミング言語とシステムデザイン](https://www.slideshare.net/tsutomuyano/ss-250915366)
    -   Clojureの設計指針 by t_yanoさん.
    -   namespaceをドメインにするればいい.
        -   データを関心領域としてそこに対する操作が関数.
        -   ドメインに操作を関数定義すればいい.
-   [システムの複雑さはどこから来るのか – Out of the tar pitを読む - Uzabase Tech](https://tech.uzabase.com/entry/2021/05/20/141950)
    -   これもby t_yanoさん.
-   ref: [📝Clojure Records]({{< relref "20220307162746.md#clojure-records" >}})
    -   Clojure Recordを積極的につかう.
-   [REPLライフをもっと快適に](https://www.slideshare.net/sohta/repl-40110261)
    -   Component 単位でシステムをつくるというアイデア, なるほど🤔

どうもOOPずぼずぼな頭なのでFPで書こうとしてもOOPに引きづられる.


## Others {#others}

-   [How to Name Clojure Functions – Digital Digressions by Stuart Sierra](https://stuartsierra.com/2016/01/09/how-to-name-clojure-functions)
    -   関数名どうするか問題.
