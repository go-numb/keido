+++
title = "📝Clojure マルチメソッド(multimethod)"
tags = ["WIKI"]
draft = false
+++

up: [📝Clojure Expression Problem]({{< relref "20220307162746.md" >}})


## マルチメソッドとは {#マルチメソッドとは}

Javaの オーバーライドをClojureで実現する方法.

同一名称のメソッドで異なる型によって処理を分けるようなことをしようとするとClojureでは,

-   **defmulti** で複数の処理を分岐させるための同一名称のメソッドを定義.
-   **defmethod** で異なる処理を型ごとに記述.

defmultiで与えられた引数のどれをdispatchのための分岐条件にするかを定義する. いいかえれば, 引数をばらして分岐条件を決める. defmethodで分岐条件に基づいて与えられた引数を処理する.

```clojure
;; 引数 sに対するバラし方を定義
(defmulti my-print class)
;; 引数sがstring, つまり (class s) => String
;; ならば(.write *out* s)を実行.
(defmethod my-print String [s] (.write *out* s))
(defmethod my-print nil [s] (.write *out* "nil"))

(my-print "stu")
```


## clojure multimethod HOWTO {#clojure-multimethod-howto}

特定条件によるif文, switch文, case文のおばけになりそうなときは積極的に導入したいところ.


### キーワードで処理をディスパッチしたい {#キーワードで処理をディスパッチしたい}

キーワードに応じてデータを処理する例.

```clojure
(defmulti ->foo (fn [x y] x))
(defmethod ->foo :type-a [x y] y)
(->foo :type-a {})
```


### namespaceで処理をディスパッチしたい {#namespaceで処理をディスパッチしたい}


## 💡いつマルチメソッドを使うべきか? {#いつマルチメソッドを使うべきか}

ref.) [📚Programming Clojure]({{< relref "20220307081341.md" >}}) より引用.

筆者がどんとなころでマルチメソッドが使われているか調査したときの発見.

-   マルチメソッドは **めったに使われない**.
-   マルチメソッドはクラスによりDispatchしていることが多い.

筆者による提案.

-   関数が1つまたは複数の型によって分岐していたら, マルチメソッドを検討する. 型とはクラスやkeywordに限らない. あなたが分岐するものと感じるもの.
-   判断に迷ったら関数版とマルチメソッド版を両方書いてみて読みやすい方を選ぶ.


## 🔗References {#references}

-   マルチメソッドは [Integrant]({{< relref "20220211142329.md#clojure-integrant" >}}) で多用されている.
-   [defmulti - clojure.core | ClojureDocs](https://clojuredocs.org/clojure.core/defmulti)
-   [マルチメソッド(multimethod)と階層 - clojure.org(ja)](https://japan-clojurians.github.io/clojure-site-ja/reference/multimethods)
