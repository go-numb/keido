+++
title = "📝Clojure: Manifold"
lastmod = 2022-10-14T08:32:25+09:00
tags = ["WIKI", "Clojure"]
draft = false
+++

-   up: [📝Clojure State and Concurrency]({{< relref "20220116191927.md" >}})
-   links
    -   <https://github.com/clj-commons/manifold>


## 📝Manifoldとは {#370573}

非同期プログラミングのための部品を提供.

2つの抽象がポイント.

-   deferreds
-   streams

deferredsとは聞き慣れないが, 延期, 先延ばしの意味. 遅延評価ということかな? streamは並行プログラミングにおける[Streams]({{< relref "20220116195030.md#d1bfb9ba-5970-4e9e-ae14-ed2d2c692f81" >}})の概念.

-   [manifold/doc](https://github.com/clj-commons/manifold/tree/master/doc) : GitHubのREADMEが詳しい.
-   <https://cljdoc.org/d/manifold/manifold/>: API doc

ManifoldのStreamを利用して作られた通信ライブラリが[aleph](#f9f86e8c-b69a-43b8-8631-64ea7c9e48e8). alephの方にもManifoldに関するドキュメントはある.


### Base Concepts {#64345e}

**deferred**, またはdeferred valuesは遅延された値という意味. 評価されていない値. <<... >>というような二重カッコで表現される. asynchronous valueともいわれる. Clojureのpromiseにcallbackを設定できるような拡張機能.

**stream** は, deferred valuesのリスト. **sink** は 情報を消費(consume)するstream, **source** は情報を生み出す(produce)stream. これらのsource/sinkの2つのstreamがセットとして一つのデータ構造に入っている. duplex streamという.

Manifoldにおけるstreamsはこのsinkとsourceの両方を併せ持つコンセプト. sinkに対してput!して, sourceに対してtake!する. Manifoldのstreamで返されるのはduplex streamのdeferredされた状態であるので, duplexの構造は内部に隠蔽されているので複数形のstreamsではなく単数形のstreamとして扱われるところは少しややこしい.

なにも取り出せない状態, 空のsourceは **drained** (枯渇)という状態になる.


### Deferreds {#a2c9c2}

<https://github.com/clj-commons/manifold/blob/master/doc/deferred.md>

deferred valueは@だったりderefで読む.


### Streams {#21b3cb}

ref. <https://github.com/clj-commons/manifold/blob/master/doc/stream.md>

streamの型をtypeで調べると, SplicedStreamとなる. spliceは余りきかない英単語だが, 連結されたの意.


### Event-Bus {#0637bb}

[⚙Publisher-Subscriberパターン]({{< relref "20221008220000.md#0b8b761b-2fb9-48f1-9777-cc09e92bed6c" >}})を実現るすための機能.

あまり情報がないが, 以下の記事は詳しい.

[A Tour of Manifold’s Deferred, Stream and Event Bus API | by Functional Human | Medium](https://functionalhuman.medium.com/a-tour-of-manifold-an-easy-to-use-library-of-building-blocks-for-asynchronous-programming-f4bb5d9c6ba9)

もしくはcore.asyncの [pub/sub]({{< relref "20220118091058.md#7c997455-af40-4663-b841-7b0e6f39ec19" >}})から類推.

[Zach Tellman - Everything Will Flow - YouTube](https://www.youtube.com/watch?v=1bNOO3xxMc0&t=1887s)


## 📝Clojure: aleph {#f9f86e8c-b69a-43b8-8631-64ea7c9e48e8}

非同期通信のためのライブラリ.

(core.asyncではなく)[📝Manifold]({{< relref "20221013151243.md" >}})のStreamをBaseにした並行制御と[Netty]({{< relref "20221011163921.md#08d70e13-298f-49af-a58d-c0dbeb76d660" >}})による非同期通信をBaseにしている.

READMEによると, HTTP通信は[clj-http]({{< relref "20220209102028.md#13a79f1f-0d95-4f2a-8c4c-b77c4ed69be1" >}})のmimicを目指す. mimicとはなんだ?調べた模倣という意味らしい.

---

-   <https://aleph.io/aleph/http.html>
-   <https://aleph.io/examples/literate.html>
-   <https://aleph.io/codox/manifold/index.html>
-   [GitHub - clj-commons/aleph: Asynchronous communication for Clojure](https://github.com/clj-commons/aleph)

参考記事.

-   [aleph/lamina: Clojureでサーバー/クライアントWebSocket - Qiita](https://qiita.com/federkasten/items/8d10f12f049aec9a236f)
-   [Clojure: aleph.tcpを使ってhttp echoサーバーを作って遊ぶ - Qiita](https://qiita.com/temp_la/items/866a58f60bcd2e5593e4)
-   [Using Aleph as a Clojure WebSocket Client | Matthew Downey](https://matthewdowney.github.io/aleph-websocket-client-not-jetty.html)


### Websocket Clinet Basics {#266090}

クライアント側の基本.

```clojure
(def ws-url "wss://ws.lightstream.bitflyer.com/json-rpc")
(def sock @(websocket-client ws-url))

(let [msg
      {:method "subscribe"
       :params {:channel "lightning_ticker_FX_BTC_JPY"}}]
  (s/put! sock (generate-string msg)))
```


## Manifold Topics {#2ab9b4}


### streamの状態を調べる関数 {#db3c19}

いろいろあるが, descriptionという関数で全部Mapで情報が取れる.

-   drained?
-   sink?
-   source?
-   closed?
-   stream?


### core.asyncとの連携 {#70c3da}

manifoldのstreamはcore.asyncのchannelに変換できる.

```clojure
(def c (async/chan))
(def s (s/->source c))
(def s (s/->sink c))
```

connectをつかって連結することもできる.

```clojure
(s/connect s c)
```


### dirigiste {#7c5790}

Manifoldの内部で利用されている. Java Thread Poolの改造.

<https://github.com/clj-commons/dirigiste>


### 💡ソース電流とシンク電流 {#b79f0d}

source, sink. manifoldの専門用語というわけではなく, 循環を示す物理や電子工学でも使われているようだ.

sinkの意味は沈むであり, 台所の流し台, なにかが溜まっていくところ. そこから吸い込み電流(シンク電流).

sourceの意味は源であり, なにかが出てくるところ, そこから吐き出し電流(ソース電流).

-   [『吐き出し電流(ソース電流)』と『吸い込み電流(シンク電流)』の違いについて！](https://detail-infomation.com/source-current-and-sink-current/)


## aleph Topics {#b28273}


### aleph接続きれる問題 {#114405}

どうもalephには途中で接続が途切れるようなことが見受けられる.

[clojure - How to ensure websocket connection is kept alive in Aleph - Stack Overflow](https://stackoverflow.com/questions/34870519/how-to-ensure-websocket-connection-is-kept-alive-in-aleph)
[Aleph - can it handle client disconnect? : Clojure](https://www.reddit.com/r/Clojure/comments/vxc7ta/aleph_can_it_handle_client_disconnect/%20)

このredditには作者本人登場してworkaroundを解説.

[Managing Websocket Stability issues with Aleph? : Clojure](https://www.reddit.com/r/Clojure/comments/48lf1a/managing_websocket_stability_issues_with_aleph/)

[sente]({{< relref "20220209102028.md#21f6271d-81ee-4219-86ce-c3a843e8e825" >}})を使えという意見も? 推測だが, websocketがそういうものでありそれを改良したものが[Socket.IO]({{< relref "20220801202422.md#ac32b357-4cfd-456e-98e9-910add42c36d" >}})なのかも(socket.ioのclojure libraryを探し中).


## 🔗References {#3b90d2}

-   [A Tour of Manifold’s Deferred, Stream and Event Bus API | by Functional Human | Medium](https://functionalhuman.medium.com/a-tour-of-manifold-an-easy-to-use-library-of-building-blocks-for-asynchronous-programming-f4bb5d9c6ba9)
-   [Manifold stream/consume, is each execution of consumpe blocking within the stream? : Clojure](https://www.reddit.com/r/Clojure/comments/47ht3e/manifold_streamconsume_is_each_execution_of/)
-   [Manifold basics in a nutshell.pdf - Speaker Deck](https://speakerdeck.com/somiel/manifold-basics-in-a-nutshell)


### examples {#bfebe3}

-   <https://github.com/lmchoi/crypto-arb/blob/master/src/crypto_arb/exchanges/common/feeds.clj>
-   <https://github.com/skyscraper/algo-trader/blob/master/src/algo_trader/handlers/utils.clj>


## See also {#611114}

-   [📝Clojure: core.async]({{< relref "20220118091058.md" >}})
-   [⚖core.async vs Manifoldの比較]({{< relref "20220116191927.md#72de97a6-0f59-43a5-a837-f0edefb744cb" >}})
